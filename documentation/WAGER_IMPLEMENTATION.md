# SPL Token Wagering System - Implementation Plan

---

## ğŸ¯ Executive Summary

### The Opportunity

Enable **real-money wagering on any Solana token** for P2P minigames â€” a first-of-its-kind feature that transforms casual gaming into competitive stakes play. Players can wager USDC, BONK, memecoins, or any SPL token on Card Jitsu, Tic-Tac-Toe, Connect 4, Monopoly, and Uno.

### Why x402 Protocol

| Advantage | What It Means |
|-----------|---------------|
| **Instant Settlement** | Winner receives tokens the moment the game ends â€” no delays |
| **Any SPL Token** | Support USDC, BONK, custom tokens â€” opens doors for token partnerships |
| **Pre-Signed Authorization** | No funds locked in escrow; tokens stay in player wallets until settlement |
| **Server-Authoritative** | Cheat-proof, dispute-free â€” server determines winner, executes payout |
| **Gasless for Users** | Settlement happens server-side; players just sign once |

### Business Impact

| Metric | Potential |
|--------|-----------|
| **New Revenue Stream** | Optional rake/fee on wagers (configurable) |
| **User Retention** | Stakes = engagement; players return to win back losses or grow winnings |
| **Viral Growth** | "I just won 1000 $BONK playing Card Jitsu" â€” shareable moments |
| **Token Partnerships** | Partner with token projects for sponsored tournaments, exclusive wagers |
| **Competitive Moat** | Few competitors offer multi-token P2P wagering with this UX |

### Technical Confidence

| Factor | Status |
|--------|--------|
| **Implementation Time** | 5-9 days (leverages existing challenge/match infrastructure) |
| **Settlement Success Rate** | Target 99%+ with retry logic and balance checks |
| **Security** | Zero client-side exploit vectors; all payouts server-initiated |
| **Compliance Ready** | Full audit trail â€” every wager, signature, and settlement logged |
| **Scalability** | Same architecture handles 10 or 10,000 concurrent matches |

### User Experience Highlights

1. **Challenger** picks any token, enters amount â†’ signs once â†’ challenge sent
2. **Opponent** sees token details + "Buy on Jupiter" link if needed â†’ signs once â†’ game starts
3. **Game plays** exactly as before â€” no UX changes during gameplay
4. **Winner** receives tokens instantly with on-chain proof (Solscan link)

---

## Overview

Allow players to wager any Solana SPL token on P2P minigames (Card Jitsu, Tic-Tac-Toe, Connect 4, Monopoly, Uno). The system uses the **x402 payment protocol** for secure, pre-signed payment authorizations - both players sign x402 payments to their opponent before the match starts, and only the loser's payment is settled via x402 after the game ends.

---

## Existing Infrastructure (REUSE)

### âœ… Already Built - Can Reuse Directly

| Component | Location | What It Does | Reuse Strategy |
|-----------|----------|--------------|----------------|
| **ChallengeContext** | `src/challenge/ChallengeContext.jsx` | Client-side challenge state, inbox, match tracking | **EXTEND** - add wagerToken config |
| **ChallengeService** | `server/services/ChallengeService.js` | Server challenge lifecycle, expiry cleanup | **EXTEND** - add wagerToken fields |
| **Challenge Model** | `server/db/models/Challenge.js` | MongoDB schema with `wagerAmount` | **EXTEND** - add wagerToken schema |
| **MatchService** | `server/services/MatchService.js` | Match creation, state management | **EXTEND** - add token settlement |
| **Match Model** | `server/db/models/Match.js` | MongoDB schema with `wagerAmount` | **EXTEND** - add wagerToken schema |
| **WagerModal** | `src/components/WagerModal.jsx` | Amount input, quick amounts, validation | **EXTEND** - add token selector |
| **SolanaPaymentService** | `server/services/SolanaPaymentService.js` | `getTokenBalance()`, `checkMinimumBalance()` | **REUSE AS-IS** |
| **X402Service (Client)** | `src/wallet/X402Service.js` | `createWagerPayment()`, `createPaymentPayload()` | **EXTEND** - accept any token |
| **X402Service (Server)** | `server/services/X402Service.js` | `verifyPayloadLocal()`, signature verification | **REUSE AS-IS** |
| **Inbox System** | Challenge notifications in `ChallengeContext` | Shows challenges, accept/decline | **EXTEND** - show token details |

### âš ï¸ Needs Modification

| Component | Current Behavior | Required Change |
|-----------|-----------------|-----------------|
| `handleWagerEscrow()` | Escrows in-game coins via `UserService` | Replace with pre-signed payment storage |
| `handleMatchPayout()` | Pays out in-game coins | Replace with SPL token settlement |
| `X402Service.createWagerPayment()` | Hardcoded to CPW3 token | Accept any SPL token address |
| `Challenge.wagerAmount` | Just a number | Add token address, symbol, decimals |
| `Match.wagerAmount` | Just a number | Add token address, symbol, decimals |

---

## Architecture - Complete Flow Diagrams (All Paths)

### PHASE 1: Challenge Creation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PLAYER A CREATES CHALLENGE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Opens WagerModal             â”‚
                    â”‚  - Selects token (CA/preset)  â”‚
                    â”‚  - Enters wager amount        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CLIENT: Validate Token CA    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ— INVALID TOKEN     â”‚                â”‚ âœ“ VALID TOKEN           â”‚
    â”‚                     â”‚                â”‚                         â”‚
    â”‚ Error: "Invalid     â”‚                â”‚ Fetch metadata (symbol, â”‚
    â”‚ token address"      â”‚                â”‚ decimals) from chain    â”‚
    â”‚                     â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ [FLOW ENDS]         â”‚                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ CLIENT: Check A's       â”‚
                                        â”‚ balance via RPC         â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚              â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â–¼                                        â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ âœ— INSUFFICIENT BALANCE  â”‚              â”‚ âœ“ BALANCE OK            â”‚
                    â”‚                         â”‚              â”‚                         â”‚
                    â”‚ Error: "Need X more     â”‚              â”‚ Prompt wallet to sign   â”‚
                    â”‚ $TOKEN to wager"        â”‚              â”‚ payment â†’ Player B      â”‚
                    â”‚                         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ [Show Jupiter buy link] â”‚                           â”‚
                    â”‚                         â”‚                           â–¼
                    â”‚ [FLOW ENDS]             â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ X402 createWagerPayment â”‚
                                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚              â”‚
                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                      â–¼                                        â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ âœ— USER REJECTED SIGN    â”‚              â”‚ âœ“ SIGNED SUCCESSFULLY   â”‚
                                        â”‚                         â”‚              â”‚                         â”‚
                                        â”‚ User cancelled in       â”‚              â”‚ Send to server:         â”‚
                                        â”‚ wallet popup            â”‚              â”‚ - wagerToken config     â”‚
                                        â”‚                         â”‚              â”‚ - signedPayload         â”‚
                                        â”‚ [FLOW ENDS]             â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
                                                                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                SERVER: ChallengeService.createChallenge()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                       â”‚                                       â”‚
                    â–¼                                       â–¼                                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CHECK 1: Signature Valid? â”‚        â”‚ CHECK 2: Balance on-chain?â”‚        â”‚ CHECK 3: Payload Match?   â”‚
    â”‚ nacl.sign.verify()        â”‚        â”‚ getTokenBalance()         â”‚        â”‚ amount, token, recipient  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                    â”‚                                    â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼                 â–¼                  â–¼                 â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚âœ— INVALIDâ”‚      â”‚âœ“ VALID  â”‚        â”‚âœ— DROPPEDâ”‚      â”‚âœ“ HAS IT â”‚        â”‚âœ— MISMATCHâ”‚     â”‚âœ“ MATCHESâ”‚
â”‚         â”‚      â”‚         â”‚        â”‚         â”‚      â”‚         â”‚        â”‚         â”‚      â”‚         â”‚
â”‚ Error:  â”‚      â”‚Continue â”‚        â”‚ Error:  â”‚      â”‚Continue â”‚        â”‚ Error:  â”‚      â”‚Continue â”‚
â”‚"Invalid â”‚      â”‚         â”‚        â”‚"Balance â”‚      â”‚         â”‚        â”‚"Payload â”‚      â”‚         â”‚
â”‚signatureâ”‚      â”‚         â”‚        â”‚changed" â”‚      â”‚         â”‚        â”‚tampered"â”‚      â”‚         â”‚
â”‚"        â”‚      â”‚         â”‚        â”‚         â”‚      â”‚         â”‚        â”‚         â”‚      â”‚         â”‚
â”‚[END]    â”‚      â”‚         â”‚        â”‚[END]    â”‚      â”‚         â”‚        â”‚[END]    â”‚      â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                                            â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ CHECK 4: Nonce unused?    â”‚
                                        â”‚ (Replay attack prevention)â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚              â”‚
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â–¼                                â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ âœ— NONCE REUSED  â”‚              â”‚ âœ“ FRESH NONCE   â”‚
                            â”‚                 â”‚              â”‚                 â”‚
                            â”‚ Error: "Replay  â”‚              â”‚ âœ“ ALL CHECKS    â”‚
                            â”‚ attack detected"â”‚              â”‚ PASSED!         â”‚
                            â”‚                 â”‚              â”‚                 â”‚
                            â”‚ [LOG + END]     â”‚              â”‚ Challenge saved â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ Notify Player B â”‚
                                                             â”‚                 â”‚
                                                             â”‚ [CONTINUE â†’]    â”‚
                                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PHASE 2: Challenge Response

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PLAYER B RECEIVES CHALLENGE                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Inbox shows challenge:       â”‚
                    â”‚  - Token symbol + amount      â”‚
                    â”‚  - Token CA (copyable)        â”‚
                    â”‚  - "Buy on Jupiter" link      â”‚
                    â”‚  - Your balance: X $TOKEN     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                       â”‚                       â”‚
            â–¼                       â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   DECLINE     â”‚       â”‚    IGNORE     â”‚       â”‚    ACCEPT     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚                       â”‚
            â–¼                       â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Server:       â”‚       â”‚ 5 min timeout     â”‚   â”‚ Check B's balance â”‚
    â”‚ status â†’      â”‚       â”‚ triggers cleanup  â”‚   â”‚ for wager token   â”‚
    â”‚ 'declined'    â”‚       â”‚                   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚       â”‚ Server:           â”‚           â”‚
    â”‚ Notify A:     â”‚       â”‚ status â†’ 'expired'â”‚      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ "B declined"  â”‚       â”‚                   â”‚      â–¼         â–¼
    â”‚               â”‚       â”‚ Notify A:         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ [FLOW ENDS]   â”‚       â”‚ "Challenge expiredâ”‚ â”‚âœ— LOW BALâ”‚ â”‚âœ“ ENOUGH     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                   â”‚ â”‚         â”‚ â”‚             â”‚
                            â”‚ [FLOW ENDS]       â”‚ â”‚"Need X  â”‚ â”‚Sign payment â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚more"    â”‚ â”‚to Player A  â”‚
                                                  â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚[Jupiter â”‚        â”‚
                                                  â”‚link]    â”‚        â–¼
                                                  â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚[END]    â”‚ â”‚X402 sign â†’ A    â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                     â”‚
                                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                            â–¼                 â–¼
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚âœ— REJECTED       â”‚ â”‚âœ“ SIGNED         â”‚
                                                  â”‚                 â”‚ â”‚                 â”‚
                                                  â”‚User cancelled   â”‚ â”‚Send to server   â”‚
                                                  â”‚                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚[END]            â”‚        â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                SERVER: ChallengeService.acceptChallenge()                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                           â”‚                                           â”‚
                â–¼                                           â–¼                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHECK 1: A still has balance? â”‚        â”‚ CHECK 2: B's signature valid? â”‚        â”‚ CHECK 3: Recipient correct?   â”‚
â”‚ Re-verify challenger funds    â”‚        â”‚ nacl.sign.verify()            â”‚        â”‚ B signed to A's wallet?       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                        â”‚                                        â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
  â–¼               â–¼                        â–¼               â–¼                        â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚âœ— DROP â”‚    â”‚âœ“ STILL  â”‚              â”‚âœ— BAD  â”‚    â”‚âœ“ VALID  â”‚              â”‚âœ— WRONG    â”‚    â”‚âœ“ CORRECTâ”‚
â”‚       â”‚    â”‚ HAS IT  â”‚              â”‚ SIG   â”‚    â”‚         â”‚              â”‚ RECIPIENT â”‚    â”‚         â”‚
â”‚Error: â”‚    â”‚         â”‚              â”‚       â”‚    â”‚         â”‚              â”‚           â”‚    â”‚         â”‚
â”‚"A can â”‚    â”‚Continue â”‚              â”‚[END]  â”‚    â”‚Continue â”‚              â”‚"Payment   â”‚    â”‚Continue â”‚
â”‚no     â”‚    â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚must go to â”‚    â”‚         â”‚
â”‚longer â”‚    â”‚         â”‚                                                    â”‚challenger"â”‚    â”‚         â”‚
â”‚cover" â”‚    â”‚         â”‚                                                    â”‚           â”‚    â”‚         â”‚
â”‚       â”‚    â”‚         â”‚                                                    â”‚[END]      â”‚    â”‚         â”‚
â”‚Cancel â”‚    â”‚         â”‚                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚match  â”‚    â”‚         â”‚
â”‚       â”‚    â”‚         â”‚
â”‚[END]  â”‚    â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                                            â–¼
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ âœ“ ALL ACCEPTANCE CHECKS PASS  â”‚
                                            â”‚                               â”‚
                                            â”‚ - Store both signed payloads  â”‚
                                            â”‚ - Create Match via MatchServiceâ”‚
                                            â”‚ - Match status â†’ 'active'     â”‚
                                            â”‚ - Notify both players         â”‚
                                            â”‚                               â”‚
                                            â”‚ [GAME STARTS â†’]               â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PHASE 3: Game In Progress

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GAME IN PROGRESS (Match status: 'active')                  â”‚
â”‚                      Both signatures stored securely on server                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                               â”‚
        â–¼                           â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NORMAL PLAY   â”‚           â”‚ FORFEIT       â”‚               â”‚ DISCONNECT        â”‚
â”‚               â”‚           â”‚               â”‚               â”‚                   â”‚
â”‚ Players make  â”‚           â”‚ Player clicks â”‚               â”‚ Player loses      â”‚
â”‚ legal moves   â”‚           â”‚ forfeit btn   â”‚               â”‚ connection        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                               â”‚
        â”‚                           â–¼                               â–¼
        â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚ SERVER: Forfeit   â”‚           â”‚ 60 second grace   â”‚
        â”‚                   â”‚                   â”‚           â”‚ period starts     â”‚
        â”‚                   â”‚ A forfeits â†’      â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚ Winner = B        â”‚                   â”‚
        â”‚                   â”‚                   â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚ B forfeits â†’      â”‚          â–¼                 â–¼
        â”‚                   â”‚ Winner = A        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚   â”‚ RECONNECTS  â”‚   â”‚ TIMEOUT     â”‚
        â”‚                   â”‚ [SETTLE â†’]        â”‚   â”‚             â”‚   â”‚             â”‚
        â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Game        â”‚   â”‚ Other playerâ”‚
        â”‚                                           â”‚ continues   â”‚   â”‚ wins        â”‚
        â”‚                                           â”‚             â”‚   â”‚             â”‚
        â”‚                                           â”‚ [CONTINUE]  â”‚   â”‚ [SETTLE â†’]  â”‚
        â”‚                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           GAME OUTCOMES (Server Determines)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PLAYER A WINS   â”‚       â”‚   PLAYER B WINS   â”‚       â”‚      DRAW         â”‚
â”‚                   â”‚       â”‚                   â”‚       â”‚                   â”‚
â”‚ Server determines â”‚       â”‚ Server determines â”‚       â”‚ Server determines â”‚
â”‚ A is winner       â”‚       â”‚ B is winner       â”‚       â”‚ no winner         â”‚
â”‚                   â”‚       â”‚                   â”‚       â”‚                   â”‚
â”‚ Settlement:       â”‚       â”‚ Settlement:       â”‚       â”‚ No settlement     â”‚
â”‚ Execute B's       â”‚       â”‚ Execute A's       â”‚       â”‚ Both signatures   â”‚
â”‚ signed payment    â”‚       â”‚ signed payment    â”‚       â”‚ discarded         â”‚
â”‚ B â†’ A             â”‚       â”‚ A â†’ B             â”‚       â”‚                   â”‚
â”‚                   â”‚       â”‚                   â”‚       â”‚ Notify: "Draw,    â”‚
â”‚ [SETTLE â†’]        â”‚       â”‚ [SETTLE â†’]        â”‚       â”‚ no tokens moved"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                   â”‚
                                                        â”‚ [FLOW ENDS]       â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DISCONNECT SCENARIOS                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A DISCONNECTS     â”‚       â”‚ B DISCONNECTS     â”‚       â”‚ BOTH DISCONNECT   â”‚
â”‚                   â”‚       â”‚                   â”‚       â”‚                   â”‚
â”‚ 60s grace period  â”‚       â”‚ 60s grace period  â”‚       â”‚ 60s grace period  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â–¼         â–¼                 â–¼         â–¼                 â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚A backâ”‚  â”‚Timeoutâ”‚         â”‚B backâ”‚  â”‚Timeoutâ”‚         â”‚1 backâ”‚  â”‚Neither â”‚
â”‚      â”‚  â”‚      â”‚         â”‚      â”‚  â”‚      â”‚         â”‚      â”‚  â”‚returns â”‚
â”‚Game  â”‚  â”‚B winsâ”‚         â”‚Game  â”‚  â”‚A winsâ”‚         â”‚Game  â”‚  â”‚        â”‚
â”‚goes  â”‚  â”‚      â”‚         â”‚goes  â”‚  â”‚      â”‚         â”‚goes  â”‚  â”‚DRAW    â”‚
â”‚on    â”‚  â”‚[SET] â”‚         â”‚on    â”‚  â”‚[SET] â”‚         â”‚on    â”‚  â”‚No settleâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PHASE 4: Settlement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SETTLEMENT (Server-Initiated Only)                         â”‚
â”‚                      WagerSettlementService.settleWager(match)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Match status â†’ 'settling'     â”‚
                    â”‚ (Prevents double-settle)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CHECK: Already settled?       â”‚
                    â”‚ (Idempotency check)           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âœ“ ALREADY SETTLED   â”‚                â”‚ NOT YET SETTLED     â”‚
    â”‚                     â”‚                â”‚                     â”‚
    â”‚ Return existing     â”‚                â”‚ Continue with       â”‚
    â”‚ transaction hash    â”‚                â”‚ settlement...       â”‚
    â”‚                     â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ [FLOW ENDS]         â”‚                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ Identify loser & winner â”‚
                                        â”‚                         â”‚
                                        â”‚ Loser = not winner      â”‚
                                        â”‚ Get loser's signed      â”‚
                                        â”‚ payload from storage    â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ FINAL BALANCE CHECK     â”‚
                                        â”‚                         â”‚
                                        â”‚ Does loser STILL have   â”‚
                                        â”‚ enough tokens on-chain? â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚              â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â–¼                                        â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ âœ— BALANCE DROPPED       â”‚              â”‚ âœ“ BALANCE CONFIRMED     â”‚
                    â”‚                         â”‚              â”‚                         â”‚
                    â”‚ Loser spent tokens      â”‚              â”‚ Execute SPL transfer    â”‚
                    â”‚ during the game!        â”‚              â”‚ using signed payload    â”‚
                    â”‚                         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Status: settlement_fail â”‚                           â”‚
                    â”‚                         â”‚                           â–¼
                    â”‚ Log for admin review:   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ - matchId               â”‚              â”‚ Submit transaction      â”‚
                    â”‚ - loserWallet           â”‚              â”‚ to Solana network       â”‚
                    â”‚ - expectedAmount        â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ - actualBalance         â”‚                      â”‚              â”‚
                    â”‚                         â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Notify both players:    â”‚             â–¼                                â–¼
                    â”‚ "Settlement failed -    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ loser balance dropped"  â”‚  â”‚ âœ— TRANSACTION FAILED    â”‚  â”‚ âœ“ TRANSACTION SUCCESS   â”‚
                    â”‚                         â”‚  â”‚                         â”‚  â”‚                         â”‚
                    â”‚ [FLOW ENDS - FAILED]    â”‚  â”‚ Network/RPC error       â”‚  â”‚ Store tx signature      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                         â”‚  â”‚ Match status â†’          â”‚
                                                 â”‚ Retry logic:            â”‚  â”‚ 'completed'             â”‚
                                                 â”‚ - Wait 5 seconds        â”‚  â”‚                         â”‚
                                                 â”‚ - Retry up to 3 times   â”‚  â”‚ Notify winner:          â”‚
                                                 â”‚ - Exponential backoff   â”‚  â”‚ "You won X $TOKEN!"     â”‚
                                                 â”‚                         â”‚  â”‚ [Solscan link]          â”‚
                                                 â”‚ If all retries fail:    â”‚  â”‚                         â”‚
                                                 â”‚ - Log error             â”‚  â”‚ Notify loser:           â”‚
                                                 â”‚ - Alert admin           â”‚  â”‚ "You lost X $TOKEN"     â”‚
                                                 â”‚ - Status: pending_manualâ”‚  â”‚ [Solscan link]          â”‚
                                                 â”‚                         â”‚  â”‚                         â”‚
                                                 â”‚ [FLOW ENDS - PENDING]   â”‚  â”‚ [FLOW ENDS - SUCCESS]   â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Edge Case Summary Table

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    EDGE CASE HANDLING MATRIX                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                             â”‚
â”‚  CHALLENGE CREATION FAILURES                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Error                    â”‚ When It Happens             â”‚ How We Handle                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Invalid token address    â”‚ User pastes bad CA          â”‚ Block submit, show "Invalid address"        â”‚  â”‚
â”‚  â”‚ Insufficient balance     â”‚ User doesn't have tokens    â”‚ Show balance + Jupiter buy link             â”‚  â”‚
â”‚  â”‚ Wallet rejected sign     â”‚ User clicks reject/cancel   â”‚ Cancel flow, no error logged                â”‚  â”‚
â”‚  â”‚ Signature invalid        â”‚ Tampering or client bug     â”‚ Reject, log for security review             â”‚  â”‚
â”‚  â”‚ Payload mismatch         â”‚ Amount/recipient tampered   â”‚ Reject, log for security review             â”‚  â”‚
â”‚  â”‚ Balance dropped          â”‚ User spent between actions  â”‚ "Balance changed, please retry"             â”‚  â”‚
â”‚  â”‚ Nonce already used       â”‚ Replay attack attempt       â”‚ Reject, log security alert                  â”‚  â”‚
â”‚  â”‚ Target player offline    â”‚ Opponent not connected      â”‚ Challenge saved, delivered when online      â”‚  â”‚
â”‚  â”‚ Duplicate challenge      â”‚ Already challenged this userâ”‚ "Challenge already pending"                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                             â”‚
â”‚  CHALLENGE RESPONSE FAILURES                                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Error                    â”‚ When It Happens             â”‚ How We Handle                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Challenge expired        â”‚ 5 min timeout reached       â”‚ Auto-cleanup job, notify challenger          â”‚  â”‚
â”‚  â”‚ Challenge declined       â”‚ B clicks decline button     â”‚ Notify A "Challenge declined"               â”‚  â”‚
â”‚  â”‚ B has insufficient bal   â”‚ B doesn't own the token     â”‚ Show CA + Jupiter link + "Need X more"      â”‚  â”‚
â”‚  â”‚ B wallet rejected        â”‚ B cancels wallet popup      â”‚ Cancel acceptance, no error                 â”‚  â”‚
â”‚  â”‚ B signature invalid      â”‚ Tampering or client bug     â”‚ Reject acceptance, log security             â”‚  â”‚
â”‚  â”‚ A balance dropped        â”‚ A spent tokens while waitingâ”‚ Cancel challenge "A can no longer cover"    â”‚  â”‚
â”‚  â”‚ Wrong recipient          â”‚ B signed to wrong wallet    â”‚ "Payment must be to challenger"             â”‚  â”‚
â”‚  â”‚ Challenge already gone   â”‚ Race condition              â”‚ "Challenge no longer exists"                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                             â”‚
â”‚  GAME PHASE FAILURES                                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Error                    â”‚ When It Happens             â”‚ How We Handle                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Player forfeits          â”‚ Manual forfeit button       â”‚ Opponent wins, settle their payment         â”‚  â”‚
â”‚  â”‚ One player disconnects   â”‚ Network/tab close           â”‚ 60s grace period, then opponent wins        â”‚  â”‚
â”‚  â”‚ Both players disconnect  â”‚ Both lose connection        â”‚ 60s grace, if neither returns â†’ DRAW        â”‚  â”‚
â”‚  â”‚ Invalid game move        â”‚ Client sends illegal move   â”‚ Server rejects move, request valid one      â”‚  â”‚
â”‚  â”‚ Move timeout             â”‚ No move for 2 minutes       â”‚ Warn player, then forfeit if no response    â”‚  â”‚
â”‚  â”‚ Match timeout            â”‚ No activity for 10 minutes  â”‚ Forfeit inactive player                     â”‚  â”‚
â”‚  â”‚ Server restart mid-game  â”‚ Server maintenance          â”‚ Match state persisted, resume on reconnect  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                             â”‚
â”‚  SETTLEMENT PHASE FAILURES                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Error                    â”‚ When It Happens             â”‚ How We Handle                                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Loser balance dropped    â”‚ Loser spent during game     â”‚ Log for admin, mark settlement_failed       â”‚  â”‚
â”‚  â”‚ Transaction failed       â”‚ Solana network issue        â”‚ Retry 3x with backoff, then manual review   â”‚  â”‚
â”‚  â”‚ RPC timeout              â”‚ Network congestion          â”‚ Retry with different RPC endpoint           â”‚  â”‚
â”‚  â”‚ Double settle attempt    â”‚ Race condition/retry        â”‚ Idempotency check returns existing tx       â”‚  â”‚
â”‚  â”‚ Invalid stored signature â”‚ Data corruption (rare)      â”‚ Log error, manual admin review              â”‚  â”‚
â”‚  â”‚ Signature expired        â”‚ Payload had expiry (if any) â”‚ Settlement fails, admin review              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Machine Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         STATE MACHINES                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                             â”‚
â”‚  CHALLENGE LIFECYCLE                                                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                        â”‚
â”‚                                                                                                             â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                            â”‚
â”‚      â”‚ PENDING â”‚ â†â”€â”€ Challenge created, awaiting response                                                   â”‚
â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                                            â”‚
â”‚           â”‚                                                                                                 â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€ accept â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â†’ Creates Match                                          â”‚
â”‚           â”‚                        â”‚ ACCEPTED â”‚                                                             â”‚
â”‚           â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚           â”‚                                                                                                 â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€ decline â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â†’ Notify challenger                                      â”‚
â”‚           â”‚                        â”‚ DECLINED â”‚                                                             â”‚
â”‚           â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚           â”‚                                                                                                 â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€ timeout â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â†’ Cleanup job                                            â”‚
â”‚           â”‚       (5 min)          â”‚ EXPIRED  â”‚                                                             â”‚
â”‚           â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚           â”‚                                                                                                 â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€ cancel â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â†’ Challenger cancelled                                  â”‚
â”‚                   (by challenger)  â”‚ CANCELLED â”‚                                                            â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚                                                                                                             â”‚
â”‚  MATCH LIFECYCLE                                                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                            â”‚
â”‚                                                                                                             â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                             â”‚
â”‚      â”‚ ACTIVE â”‚ â†â”€â”€ Both players connected, game in progress                                                â”‚
â”‚      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                                             â”‚
â”‚          â”‚                                                                                                  â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€ win/lose â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚          â”‚       forfeit            â”‚ SETTLING â”‚ â”€â”€â”€â”¬â”€â”€â†’ [success] â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚          â”‚       disconnect         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                  â”‚ COMPLETED â”‚                        â”‚
â”‚          â”‚                                          â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚          â”‚                                          â”‚                                                       â”‚
â”‚          â”‚                                          â””â”€â”€â†’ [failed] â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â”‚                                                             â”‚ SETTLEMENT_FAILED â”‚                â”‚
â”‚          â”‚                                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                                                                                                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€ draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”€â”€â”€â†’ No settlement needed                                 â”‚
â”‚                  (both disconnect)  â”‚ COMPLETED â”‚                                                           â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚                                                                                                             â”‚
â”‚  SETTLEMENT LIFECYCLE                                                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                       â”‚
â”‚                                                                                                             â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                            â”‚
â”‚      â”‚ PENDING â”‚ â†â”€â”€ Match ended, settlement queued                                                         â”‚
â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                                            â”‚
â”‚           â”‚                                                                                                 â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€ process â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚                                    â”‚ PROCESSING â”‚ â”€â”€â”€â”¬â”€â”€â†’ [tx success] â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                     â”‚ COMPLETED â”‚ + txHash           â”‚
â”‚                                                      â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                      â”‚                                                      â”‚
â”‚                                                      â”œâ”€â”€â†’ [balance drop] â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                                      â”‚                      â”‚ FAILED â”‚ + reason             â”‚
â”‚                                                      â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                      â”‚                                                      â”‚
â”‚                                                      â””â”€â”€â†’ [tx failed 3x] â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                                                                              â”‚ MANUAL_REVIEW â”‚              â”‚
â”‚                                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Structure Changes (Minimal)

### Challenge Model Extension
```javascript
// server/db/models/Challenge.js - ADD these fields
wagerToken: {
    tokenAddress: String,      // SPL token mint (null = in-game coins)
    tokenSymbol: String,       // Display symbol
    tokenDecimals: Number,     // For amount conversion
    amountRaw: String,         // BigInt as string (full precision)
},
challengerSignedPayload: String,  // x402 pre-signed payment: Challenger â†’ Opponent
opponentSignedPayload: String,    // x402 pre-signed payment: Opponent â†’ Challenger (filled on accept)
```

### Match Model Extension
```javascript
// server/db/models/Match.js - ADD these fields  
wagerToken: {
    tokenAddress: String,
    tokenSymbol: String,
    tokenDecimals: Number,
    amountRaw: String,         // BigInt as string (full precision)
},
player1SignedPayload: String,  // x402 signed payment: Player 1 â†’ Player 2
player2SignedPayload: String,  // x402 signed payment: Player 2 â†’ Player 1
settlementTx: String,          // Transaction signature after settlement
settlementStatus: String,      // 'pending', 'processing', 'completed', 'failed', 'manual_review'
```

---

## New Components (Only What's Missing)

### 1. WagerTokenSelector (NEW)
Location: `src/components/WagerTokenSelector.jsx`

```jsx
// Reuses SolanaPaymentService.checkMinimumBalance for balance display
<WagerTokenSelector
  selectedToken={tokenConfig}
  onTokenSelect={(config) => setTokenConfig(config)}
  walletAddress={walletAddress}
  popularTokens={POPULAR_WAGER_TOKENS}  // Config file
/>
```

Features:
- Quick-select buttons for popular tokens
- CA paste input with validation
- Auto-fetch metadata from chain (symbol, decimals)
- Show user's balance (reuse `SolanaPaymentService.getTokenBalance`)

### 2. WagerSettlementService (NEW)
Location: `server/services/WagerSettlementService.js`

```javascript
class WagerSettlementService {
    // Execute loser's pre-signed x402 payment to winner
    async settleWager(match) {
        // Reuse X402Service.verifyPayloadLocal for validation
        // Execute x402 settlement using loser's signed payload
    }
}
```

### 3. Token Metadata Hook (NEW)  
Location: `src/hooks/useTokenMetadata.js`

```javascript
// Fetch token symbol/decimals from chain
function useTokenMetadata(tokenAddress) {
    // Uses existing RPC connection from config
}
```

---

## Implementation Tasks (Reduced Scope)

### Phase 1: Schema & Service Extensions (1-2 days)
- [ ] **1.1** Add `wagerToken` fields to Challenge model
- [ ] **1.2** Add `wagerToken` + x402 payload fields to Match model  
- [ ] **1.3** Extend `X402Service.createWagerPayment()` to accept any SPL token
- [ ] **1.4** Create `WagerSettlementService` for x402 settlement

### Phase 2: UI Extensions (1-2 days)
- [ ] **2.1** Create `WagerTokenSelector` component
- [ ] **2.2** Create `useTokenMetadata` hook
- [ ] **2.3** Integrate token selector into existing `WagerModal`
- [ ] **2.4** Create `config/wagerTokens.js` with popular tokens

### Phase 3: Challenge Flow Extensions (1-2 days)
- [ ] **3.1** Extend `ChallengeService.createChallenge()` to store x402 signed payload
- [ ] **3.2** Extend `ChallengeService.acceptChallenge()` to validate & store opponent x402 payload
- [ ] **3.3** Update inbox UI to show token details + copy CA
- [ ] **3.4** Add "Buy on Jupiter" link for recipients

### Phase 4: Settlement Integration (1-2 days)
- [ ] **4.1** Replace `handleWagerEscrow()` with x402 signature storage
- [ ] **4.2** Replace `handleMatchPayout()` with x402 `WagerSettlementService`
- [ ] **4.3** Add transaction link to match results
- [ ] **4.4** Handle x402 settlement failures gracefully

### Phase 5: Polish (1 day)
- [ ] **5.1** Balance re-verification before settlement
- [ ] **5.2** Comprehensive error messages
- [ ] **5.3** Loading states

**Total: ~5-9 days** (reduced from 12-18)

---

## Code Reuse Summary

| Need | Existing Code | Action |
|------|--------------|--------|
| Token balance check | `SolanaPaymentService.getTokenBalance()` | REUSE |
| Minimum balance check | `SolanaPaymentService.checkMinimumBalance()` | REUSE |
| x402 payment signing | `X402Service.createPaymentPayload()` | EXTEND (add token param) |
| x402 signature verification | `X402Service.verifyPayloadLocal()` | REUSE |
| Challenge creation | `ChallengeService.createChallenge()` | EXTEND (add wagerToken + x402) |
| Challenge acceptance | `ChallengeService.acceptChallenge()` | EXTEND (validate x402 signatures) |
| Challenge expiry | `ChallengeService.cleanupExpired()` | REUSE |
| Match creation | `MatchService.createMatch()` | EXTEND (add wagerToken + x402) |
| Match state | `MatchService.getMatchState()` | REUSE |
| Inbox notifications | `ChallengeContext` message handlers | EXTEND |
| Wager UI | `WagerModal.jsx` | EXTEND (add token selector) |
| Quick amounts | `WagerModal` buttons | REUSE |

---

## Edge Cases (Handled by Existing Code)

| Edge Case | Already Handled By |
|-----------|-------------------|
| Challenge expiry | `ChallengeService.cleanupExpired()` |
| Player disconnect mid-game | Existing forfeit logic in `MatchService` |
| Multiple challenges | `Challenge.findExistingBetween()` |
| Duplicate handling | Existing idempotency in `ChallengeService` |
| Inbox management | Existing `inbox_delete`, TTL indexes |

## New Edge Cases to Handle

| Edge Case | Handling |
|-----------|----------|
| Invalid token CA | Validate on input before x402 signing |
| Recipient doesn't have token | Show CA + Jupiter buy link |
| Balance drops before acceptance | Re-check before storing opponent x402 signature |
| Balance drops before settlement | x402 settlement fails, log for review |
| x402 settlement transaction fails | Retry with backoff, notify players |

---

## API Changes (Minimal)

### Extend `challenge_send` message
```javascript
// Client â†’ Server (EXTEND existing)
{
  type: 'challenge_send',
  targetPlayerId: 'player_456',
  gameType: 'cardjitsu',
  wagerAmount: 100,                   // Existing (human readable)
  // NEW fields:
  wagerToken: {
    tokenAddress: 'ABC123...',
    tokenSymbol: '$BONK',
    tokenDecimals: 5,
    amountRaw: '10000000000'          // Raw amount for precision
  },
  signedPayload: 'base64...'          // x402 pre-signed payment
}
```

### Extend `challenge_received` notification  
```javascript
// Server â†’ Client (EXTEND existing)
{
  type: 'challenge_received',
  challenge: {
    // ... existing fields ...
    wagerToken: { ... },              // NEW
    challengerHasBalance: true        // NEW: did we verify their balance?
  }
}
```

### Extend `match_end` notification
```javascript
// Server â†’ Client (EXTEND existing)
{
  type: 'match_end',
  result: {
    // ... existing fields ...
    settlementTx: 'sig123...',        // NEW: x402 on-chain transaction
    solscanUrl: 'https://...'         // NEW: link to explorer
  }
}
```

---

## Configuration

### Popular Tokens Config
```javascript
// src/config/wagerTokens.js (NEW file)
export const POPULAR_WAGER_TOKENS = [
  {
    symbol: 'USDC',
    name: 'USD Coin',
    address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
    decimals: 6,
    logoURI: '/tokens/usdc.png'
  },
  {
    symbol: 'BONK',
    name: 'Bonk',
    address: 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263',
    decimals: 5,
    logoURI: '/tokens/bonk.png'
  },
  // ... more tokens
];

// Still support in-game coins (null tokenAddress)
export const IN_GAME_COINS = {
  symbol: 'ğŸª™ COINS',
  name: 'In-Game Coins',
  address: null,  // null = use existing coin system
  decimals: 0
};
```

---

## ğŸ”’ Security Model: Server Authority

**Core Principle: The server is the ONLY source of truth. Clients can request and sign, but NEVER determine outcomes.**

### What Clients CAN Do
| Action | Client Role | Server Verification |
|--------|-------------|---------------------|
| Select token & amount | Proposes wager config | Server validates token exists, amount > 0 |
| Sign x402 payment payload | Signs with their private key | Server verifies x402 signature cryptographically |
| Send challenge | Requests to challenge | Server checks both players exist, no duplicates |
| Accept challenge | Signs x402 counter-payment | Server validates x402 signature + balance |
| Play game moves | Sends move intentions | Server validates move is legal |
| Request forfeit | Asks to forfeit | Server executes forfeit logic |

### What Clients CANNOT Do
| Blocked Action | How It's Prevented |
|----------------|-------------------|
| âŒ Claim false balance | Server queries chain directly via `SolanaPaymentService.getTokenBalance()` |
| âŒ Forge x402 signatures | Server verifies with `nacl.sign.detached.verify()` |
| âŒ Declare themselves winner | Only `MatchService.endMatch()` determines winner |
| âŒ Trigger own payout | Only server calls `WagerSettlementService.settleWager()` |
| âŒ Modify wager after signing | x402 payload is immutable, signature invalidates on change |
| âŒ Replay old x402 signatures | Unique nonce per payload, server tracks used nonces |
| âŒ Settle before game ends | x402 settlement only called from `match_end` handler |
| âŒ Double-settle | Match status check + idempotency key on x402 settlement |

### Server-Side Security Checks

#### 1. Challenge Creation (server/services/ChallengeService.js)
```javascript
async createChallenge(challenger, target, gameType, wagerConfig, signedPayload) {
    // SECURITY: Never trust client-provided balance
    const actualBalance = await solanaPaymentService.getTokenBalance(
        challenger.walletAddress,
        wagerConfig.tokenAddress
    );
    
    // Compare raw amounts (BigInt strings) for precision
    if (BigInt(actualBalance) < BigInt(wagerConfig.amountRaw)) {
        return { error: 'INSUFFICIENT_BALANCE', message: 'Server verified: insufficient funds' };
    }
    
    // SECURITY: Verify x402 signature cryptographically
    const verification = await x402Service.verifyPayloadLocal(signedPayload);
    if (!verification.valid) {
        return { error: 'INVALID_SIGNATURE', message: 'x402 signature verification failed' };
    }
    
    // SECURITY: Verify x402 payload matches claimed wager
    const payload = verification.payload;
    if (payload.amount !== wagerConfig.amountRaw || 
        payload.token !== wagerConfig.tokenAddress ||
        payload.recipient !== target.walletAddress) {
        return { error: 'PAYLOAD_MISMATCH', message: 'x402 payload does not match wager' };
    }
    
    // SECURITY: Check nonce not already used (prevent replay)
    if (await this.isNonceUsed(payload.nonce)) {
        return { error: 'REPLAY_ATTACK', message: 'This x402 signature has already been used' };
    }
    
    // ... proceed with challenge creation
}
```

#### 2. Challenge Acceptance (server/services/ChallengeService.js)
```javascript
async acceptChallenge(challengeId, opponentWallet, signedPayload) {
    const challenge = await Challenge.findOne({ challengeId });
    
    // SECURITY: Re-verify challenger still has balance (may have changed)
    const challengerBalance = await solanaPaymentService.getTokenBalance(
        challenge.challengerWallet,
        challenge.wagerToken.tokenAddress
    );
    if (BigInt(challengerBalance) < BigInt(challenge.wagerToken.amountRaw)) {
        return { error: 'CHALLENGER_BALANCE_DROPPED', message: 'Challenger no longer has funds' };
    }
    
    // SECURITY: Verify opponent balance
    const opponentBalance = await solanaPaymentService.getTokenBalance(
        opponentWallet,
        challenge.wagerToken.tokenAddress
    );
    if (BigInt(opponentBalance) < BigInt(challenge.wagerToken.amountRaw)) {
        return { error: 'INSUFFICIENT_BALANCE', message: 'You need more tokens' };
    }
    
    // SECURITY: Verify opponent's x402 signature
    const verification = await x402Service.verifyPayloadLocal(signedPayload);
    if (!verification.valid) {
        return { error: 'INVALID_SIGNATURE', message: 'x402 signature verification failed' };
    }
    
    // SECURITY: Verify opponent signed x402 payment TO challenger (not to themselves!)
    if (verification.payload.recipient !== challenge.challengerWallet) {
        return { error: 'WRONG_RECIPIENT', message: 'x402 payment must be to challenger' };
    }
    
    // ... proceed with acceptance, store both x402 payloads
}
```

#### 3. Match Completion (server/services/MatchService.js)
```javascript
async endMatch(matchId, winnerId, reason) {
    const match = await Match.findOne({ matchId });
    
    // SECURITY: Match must exist and be active
    if (!match || match.status !== 'active') {
        throw new Error('Invalid match state');
    }
    
    // SECURITY: Winner must be one of the players (server determines winner)
    if (winnerId !== match.player1.playerId && winnerId !== match.player2.playerId) {
        throw new Error('Invalid winner');
    }
    
    // SECURITY: Mark match as settling BEFORE x402 settlement (prevent double-settle)
    match.status = 'settling';
    match.winnerId = winnerId;
    await match.save();
    
    // SECURITY: x402 settlement is server-initiated only
    if (match.wagerToken?.tokenAddress) {
        const settlementResult = await wagerSettlementService.settleWager(match);
        match.settlementTx = settlementResult.transactionHash;
        match.settlementStatus = settlementResult.success ? 'completed' : 'failed';
    }
    
    match.status = 'completed';
    await match.save();
    
    return match;
}
```

#### 4. Wager Settlement (server/services/WagerSettlementService.js)
```javascript
class WagerSettlementService {
    async settleWager(match) {
        // SECURITY: Can only be called by server (no client endpoint exists)
        // SECURITY: Match must be in 'settling' status
        if (match.status !== 'settling') {
            throw new Error('Invalid match status for x402 settlement');
        }
        
        // SECURITY: Idempotency - check if already settled
        if (match.settlementTx) {
            return { success: true, transactionHash: match.settlementTx, alreadySettled: true };
        }
        
        // Determine loser (whose x402 payment we execute)
        const loserWallet = match.winnerId === match.player1.playerId 
            ? match.player2.wallet 
            : match.player1.wallet;
        const winnerWallet = match.winnerId === match.player1.playerId
            ? match.player1.wallet
            : match.player2.wallet;
        
        // Get loser's x402 signed payload
        const loserPayload = match.winnerId === match.player1.playerId
            ? match.player2SignedPayload
            : match.player1SignedPayload;
        
        // SECURITY: Final balance check before executing x402 transfer
        const loserBalance = await solanaPaymentService.getTokenBalance(
            loserWallet,
            match.wagerToken.tokenAddress
        );
        
        if (BigInt(loserBalance) < BigInt(match.wagerToken.amountRaw)) {
            // Log for admin review, but don't execute
            console.error(`âš ï¸ x402 settlement failed: ${loserWallet} balance dropped`);
            return { 
                success: false, 
                error: 'INSUFFICIENT_BALANCE_AT_SETTLEMENT',
                loserWallet,
                requiredAmount: match.wagerToken.amountRaw,
                actualBalance: loserBalance
            };
        }
        
        // SECURITY: Execute x402 transfer using loser's pre-signed payload
        // Server has authority to settle - loser already authorized this payment
        const txResult = await x402Service.settlePayment(loserPayload);
        
        return {
            success: txResult.success,
            transactionHash: txResult.signature,
            from: loserWallet,
            to: winnerWallet,
            amountRaw: match.wagerToken.amountRaw
        };
    }
}
```

### Attack Prevention Summary

| Attack Vector | Prevention |
|---------------|------------|
| **Balance Spoofing** | Server queries blockchain directly, never trusts client |
| **Signature Forgery** | x402 Ed25519 signature verification with `tweetnacl` |
| **Replay Attack** | Unique nonce per x402 payload, server tracks used nonces |
| **Winner Manipulation** | Game logic runs server-side, client only sends moves |
| **Double Settlement** | Idempotency key (matchId), status checks before x402 settlement |
| **Self-Payment** | Server verifies x402 payload recipient matches opponent |
| **Payload Tampering** | Any change invalidates x402 signature |
| **Race Conditions** | Database transactions, atomic status updates |
| **Early Settlement** | x402 settlement only triggered from `endMatch()` |
| **Unauthorized Settlement** | No client-facing x402 settlement endpoint exists |

### Trust Boundaries

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT (UNTRUSTED)                       â”‚
â”‚   - Can view game state                                         â”‚
â”‚   - Can sign x402 payment intents                               â”‚
â”‚   - Can send move requests                                      â”‚
â”‚   - CANNOT determine outcomes                                   â”‚
â”‚   - CANNOT trigger x402 settlements                             â”‚
â”‚   - CANNOT modify stored x402 signatures                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    WebSocket (encrypted)
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SERVER (TRUSTED)                         â”‚
â”‚   - Validates ALL client input                                  â”‚
â”‚   - Queries blockchain for balances                             â”‚
â”‚   - Verifies x402 signatures cryptographically                  â”‚
â”‚   - Runs game logic                                             â”‚
â”‚   - Determines winners                                          â”‚
â”‚   - Executes x402 settlements                                   â”‚
â”‚   - Stores audit trail                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                       x402 RPC calls
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SOLANA BLOCKCHAIN                          â”‚
â”‚   - Source of truth for balances                                â”‚
â”‚   - Executes x402 SPL transfers                                 â”‚
â”‚   - Immutable transaction records                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Changes Summary

| File | Change Type | Description |
|------|-------------|-------------|
| `server/db/models/Challenge.js` | EXTEND | Add wagerToken + x402 payload schema |
| `server/db/models/Match.js` | EXTEND | Add wagerToken + x402 payloads + settlementTx |
| `server/services/ChallengeService.js` | EXTEND | Handle x402 signed payloads |
| `server/index.js` | MODIFY | Replace escrow with x402 signature storage |
| `src/wallet/X402Service.js` | EXTEND | Accept any SPL token in createWagerPayment |
| `src/components/WagerModal.jsx` | EXTEND | Add token selector |
| `src/components/WagerTokenSelector.jsx` | NEW | Token selection UI |
| `src/hooks/useTokenMetadata.js` | NEW | Fetch token info |
| `src/config/wagerTokens.js` | NEW | Popular tokens config |
| `server/services/WagerSettlementService.js` | NEW | x402 SPL token settlement |

---

## Success Metrics

- [ ] Users can wager any SPL token (or in-game coins) via x402
- [ ] Challenge recipients see token CA + buy link
- [ ] Existing challenge flow unchanged for coin wagers
- [ ] x402 settlement success rate > 99%
- [ ] No duplicate code with igloo token system
- [ ] Clean OOP: WagerSettlementService encapsulates all x402 settlement logic
- [ ] **SECURITY: No client can manipulate payouts**
- [ ] **SECURITY: All balances verified on-chain**
- [ ] **SECURITY: All x402 signatures cryptographically verified**
- [ ] **SECURITY: Audit trail for all x402 settlements**
